<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Care Ranch - Audio Sessions</title>
  <meta name="description" content="Guided audio sessions from The Care Ranch - Works offline">

  <!-- PWA Support -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2d2520">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Care Ranch Audio">

  <link rel="stylesheet" href="style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <a href="https://www.thecareranch.com" target="_blank" rel="noopener noreferrer" class="logo-link">
        <img src="images/care-ranch-logo.png" alt="The Care Ranch Logo" class="logo">
      </a>
      <h1>The Care Ranch</h1>
      <p>Guided Audio Sessions for Your Journey</p>

      <!-- Offline Status Indicator -->
      <div class="offline-status" id="offline-status">
        <div class="status-main">
          <span class="status-icon" id="status-icon">⏳</span>
          <span class="status-text" id="status-text">Downloading for offline...</span>
        </div>
        <div class="progress-bar-container" id="progress-container" style="display: none;">
          <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div class="progress-text" id="progress-text" style="display: none;">0%</div>
      </div>
    </div>

    <!-- Offline Instructions Banner -->
    <div class="offline-banner" id="offline-banner" style="display: none;">
      ✈️ <strong>Offline Mode Ready!</strong> All audio files are downloaded. You can now use this on a plane.
    </div>

    <!-- Image Gallery -->
    <div class="image-gallery">
      <img src="images/horses-companion.png" alt="Companion horses in Arizona desert" class="gallery-image">
      <img src="images/horses-triptych.png" alt="Horses at The Care Ranch" class="gallery-image">
    </div>

    <!-- Player Section -->
    <div class="player-section">
      <div class="current-track">
        <h2 id="current-title">Select a session to begin</h2>
        <p id="current-subtitle">Choose from the playlist below</p>
      </div>

      <div class="audio-controls">
        <audio id="audio-player" class="audio-player" controls>
          <source id="audio-source" src="" type="audio/mpeg">
          Your browser does not support the audio element.
        </audio>
      </div>

      <!-- Playlist -->
      <div class="playlist">
        <h3>Available Sessions</h3>
        <div id="playlist-container">
          <!-- Playlist items will be dynamically loaded here -->
        </div>
      </div>
    </div>

    <!-- Spotify Section (Optional) -->
    <!-- Uncomment and add your Spotify playlist URL below -->
    <!--
    <div class="spotify-section">
      <h3>Additional Playlists</h3>
      <div class="spotify-embed">
        <iframe
          style="border-radius:12px"
          src="https://open.spotify.com/embed/playlist/YOUR_PLAYLIST_ID"
          width="100%"
          height="380"
          frameBorder="0"
          allowfullscreen=""
          allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
          loading="lazy">
        </iframe>
      </div>
    </div>
    -->

    <!-- Footer -->
    <div class="footer">
      <p><strong>✈️ Offline Mode:</strong> Visit this page once with internet to download all files. Then works on planes!</p>
      <p style="margin-top: 8px; opacity: 0.7;">© 2025 The Care Ranch. All rights reserved.</p>
    </div>
  </div>

  <!-- Image Modal/Lightbox -->
  <div class="image-modal" id="image-modal">
    <span class="image-modal-close" id="modal-close">&times;</span>
    <img src="" alt="Enlarged view" id="modal-image">
  </div>

  <script>
    // Audio tracks configuration
    const tracks = [
      {
        title: "Arriving in the Desert",
        subtitle: "Begin your journey",
        file: "audio/Audio - TCR Arriving in the Dessert.mp3"
      },
      {
        title: "Daily Checkout Information",
        subtitle: "End of day reflection",
        file: "audio/Audio - TCR Daily checkout information.mp3"
      },
      {
        title: "Learning Edge, Staying Present",
        subtitle: "Mindfulness practice",
        file: "audio/Audio - TCR Learning Edge, Staying Present.mp3"
      },
      {
        title: "Meeting and Mapping Your Inner Path",
        subtitle: "Self-discovery session",
        file: "audio/Audio - TCR Meeting and Mapping your Inner Pa.mp3"
      },
      {
        title: "Preparing for the Day",
        subtitle: "Morning practice",
        file: "audio/Audio - TCR Preparing for the Day.mp3"
      }
    ];

    let currentTrackIndex = 0;
    const audioPlayer = document.getElementById('audio-player');
    const audioSource = document.getElementById('audio-source');
    const currentTitle = document.getElementById('current-title');
    const currentSubtitle = document.getElementById('current-subtitle');
    const playlistContainer = document.getElementById('playlist-container');

    // Format duration from seconds to MM:SS
    function formatDuration(seconds) {
      if (isNaN(seconds) || !isFinite(seconds)) return '--:--';
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    // Load and play track
    function loadTrack(index) {
      currentTrackIndex = index;
      const track = tracks[index];

      audioSource.src = track.file;
      audioPlayer.load();

      currentTitle.textContent = track.title;
      currentSubtitle.textContent = track.subtitle;

      // Update active state in playlist
      document.querySelectorAll('.playlist-item').forEach((item, i) => {
        item.classList.toggle('active', i === index);
      });

      // Auto-play
      audioPlayer.play().catch(e => {
        console.log('Auto-play prevented by browser. Click play to start.');
      });
    }

    // Create playlist items
    function createPlaylist() {
      tracks.forEach((track, index) => {
        const item = document.createElement('div');
        item.className = 'playlist-item';
        item.innerHTML = `
          <div class="number">${index + 1}</div>
          <div class="title">${track.title}</div>
          <div class="duration" id="duration-${index}">--:--</div>
        `;

        item.addEventListener('click', () => loadTrack(index));
        playlistContainer.appendChild(item);

        // Get duration for each track
        const tempAudio = new Audio(track.file);
        tempAudio.addEventListener('loadedmetadata', () => {
          const durationElement = document.getElementById(`duration-${index}`);
          if (durationElement) {
            durationElement.textContent = formatDuration(tempAudio.duration);
          }
        });
      });
    }

    // Auto-play next track when current ends
    audioPlayer.addEventListener('ended', () => {
      const nextIndex = (currentTrackIndex + 1) % tracks.length;
      loadTrack(nextIndex);
    });

    // Initialize playlist on page load
    window.addEventListener('DOMContentLoaded', () => {
      createPlaylist();

      // Optional: Auto-load first track (uncomment to enable)
      // loadTrack(0);
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowRight') {
        const nextIndex = (currentTrackIndex + 1) % tracks.length;
        loadTrack(nextIndex);
      } else if (e.key === 'ArrowLeft') {
        const prevIndex = (currentTrackIndex - 1 + tracks.length) % tracks.length;
        loadTrack(prevIndex);
      } else if (e.key === ' ' && e.target === document.body) {
        e.preventDefault();
        if (audioPlayer.paused) {
          audioPlayer.play();
        } else {
          audioPlayer.pause();
        }
      }
    });

    // Register Service Worker for Offline Support
    if ('serviceWorker' in navigator) {
      const statusIndicator = document.getElementById('offline-status');
      const statusIcon = document.getElementById('status-icon');
      const statusText = document.getElementById('status-text');
      const progressContainer = document.getElementById('progress-container');
      const progressBar = document.getElementById('progress-bar');
      const progressText = document.getElementById('progress-text');

      // Set initial downloading state
      statusIndicator.className = 'offline-status downloading';
      statusIcon.textContent = '⏳';
      statusText.textContent = 'Downloading for offline...';

      // Listen for messages from service worker
      navigator.serviceWorker.addEventListener('message', (event) => {
        if (event.data.type === 'CACHE_PROGRESS') {
          // Show progress bar
          progressContainer.style.display = 'block';
          progressText.style.display = 'block';
          progressBar.style.width = event.data.percentage + '%';
          progressText.textContent = event.data.percentage + '%';
          statusText.textContent = `Downloading... (${event.data.completed}/${event.data.total})`;
        } else if (event.data.type === 'CACHE_COMPLETE') {
          updateStatusToReady();
        }
      });

      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then((registration) => {
            console.log('✅ Service Worker registered successfully');

            // Check if already activated (already cached from previous visit)
            if (registration.active && navigator.serviceWorker.controller) {
              // Check if cache exists
              caches.has('care-ranch-audio-v1').then((hasCache) => {
                if (hasCache) {
                  updateStatusToReady();
                }
              });
            }

            // Listen for new service worker installation
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'activated') {
                  // Wait for cache complete message instead of assuming ready
                  console.log('Service worker activated, waiting for cache completion...');
                }
              });
            });
          })
          .catch((error) => {
            console.log('Service Worker registration failed:', error);
            updateStatusToError();
          });
      });

      function updateStatusToReady() {
        statusIndicator.className = 'offline-status ready';
        statusIcon.textContent = '✅';
        statusText.textContent = 'Ready for offline use!';
        progressContainer.style.display = 'none';

        // Show banner briefly
        const banner = document.getElementById('offline-banner');
        if (banner) {
          banner.style.display = 'block';
          setTimeout(() => {
            banner.style.display = 'none';
          }, 8000);
        }
      }

      function updateStatusToError() {
        statusIndicator.className = 'offline-status error';
        statusIcon.textContent = '⚠️';
        statusText.textContent = 'Offline mode unavailable';
        progressContainer.style.display = 'none';
      }
    } else {
      // Service workers not supported
      const statusIndicator = document.getElementById('offline-status');
      const statusIcon = document.getElementById('status-icon');
      const statusText = document.getElementById('status-text');
      statusIndicator.className = 'offline-status error';
      statusIcon.textContent = '⚠️';
      statusText.textContent = 'Browser not supported';
    }

    // Image Modal/Lightbox functionality
    const imageModal = document.getElementById('image-modal');
    const modalImage = document.getElementById('modal-image');
    const modalClose = document.getElementById('modal-close');
    const galleryImages = document.querySelectorAll('.gallery-image');

    // Add click event to each gallery image
    galleryImages.forEach((img) => {
      img.addEventListener('click', () => {
        imageModal.classList.add('active');
        modalImage.src = img.src;
        modalImage.alt = img.alt;
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
      });
    });

    // Close modal when clicking the X
    modalClose.addEventListener('click', closeModal);

    // Close modal when clicking outside the image
    imageModal.addEventListener('click', (e) => {
      if (e.target === imageModal) {
        closeModal();
      }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && imageModal.classList.contains('active')) {
        closeModal();
      }
    });

    function closeModal() {
      imageModal.classList.remove('active');
      document.body.style.overflow = ''; // Restore scrolling
    }
  </script>
</body>
</html>
